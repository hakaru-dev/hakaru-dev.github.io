<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Hakaru Team">
        
        <link rel="shortcut icon" href="../../favicon.ico">
        

	<title>Compiling to C - Hakaru</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../logo.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Hakaru</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Introduction <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../intro/probprog/">What is Probabilistic Programming</a>
                        </li>
                    
                        <li >
                            <a href="../../intro/installation/">Installation</a>
                        </li>
                    
                        <li >
                            <a href="../../intro/quickstart/">Quick Example</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Language Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../lang/rand/">Random Primitives</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/letbind/">Let and Bind</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/cond/">Conditionals</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/coercions/">Coercions</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/functions/">Functions and Let</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/datatypes/">Datatypes and match</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/arrays/">Arrays</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Transformations <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../expect/">Expect</a>
                        </li>
                    
                        <li >
                            <a href="../disintegrate/">Disintegrate</a>
                        </li>
                    
                        <li >
                            <a href="../simplify/">Simplify</a>
                        </li>
                    
                        <li >
                            <a href="../mh/">Metropolis Hastings</a>
                        </li>
                    
                        <li >
                            <a href="../compile/">Compiling to Haskell</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Compiling to C</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Internals <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../internals/ast/">AST and Hakaru Datakind</a>
                        </li>
                    
                        <li >
                            <a href="../../internals/abt/">ABT</a>
                        </li>
                    
                        <li >
                            <a href="../../internals/datums/">Datums</a>
                        </li>
                    
                        <li >
                            <a href="../../internals/coercions/">Coercions</a>
                        </li>
                    
                        <li >
                            <a href="../../internals/transforms/">Transformaitons</a>
                        </li>
                    
                        <li >
                            <a href="../../internals/testing/">Testing</a>
                        </li>
                    
                        <li >
                            <a href="../../internals/newfeature/">Adding a Language Feautre</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../examples/">Examples</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../compile/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../../internals/ast/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/hakaru-dev/hakaru">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#hkc-compilation">HKC Compilation</a></li>
        
            <li><a href="#type-conversions">Type Conversions</a></li>
        
            <li><a href="#measures">Measures</a></li>
        
            <li><a href="#lambdas">Lambdas</a></li>
        
            <li><a href="#computations">Computations</a></li>
        
            <li><a href="#parallel-programs">Parallel Programs</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="hkc-compilation">HKC Compilation</h1>
<p><code>hkc</code> is a command line tool to compiler Hakaru programs to C. HKC was
created with portability and speed in mind. More recently, OpenMP support is
being added to gain more performance on multi-core machines. Basic command line
usage of HKC is much like other compilers:</p>
<pre><code>hkc foo.hk -o foo.c
</code></pre>

<p>It is possible to go straight to an executable with the <code>--make ARG</code> flag, where
the argument is the C compiler you would like to use.</p>
<h2 id="type-conversions">Type Conversions</h2>
<p>The types available in Hakaru programs are the following: <code>nat</code>, <code>int</code>, <code>real</code>,
<code>prob</code>, <code>array(&lt;type&gt;)</code>, <code>measure(&lt;type&gt;)</code>, and datum like <code>true</code> and <code>false</code>.</p>
<p><code>nat</code> and <code>int</code> have a trivial mapping to the C <code>int</code> type. <code>real</code> becomes a C
<code>double</code>. The <code>prob</code> type in Hakaru is stored in the log-domain to avoid
underflow. In C this corresponds to a <code>double</code>, but we first take the log of it
before storing it, so we have to take the exp of it to bring it back to the real
numbers.</p>
<p>Arrays become structs that contain the size and a pointer to data stored within.
The structs are generated at compile time, but there are only four which are
named after the type they contain. Here they all are:</p>
<pre><code>struct arrayNat {
  int size; int * data;
};

struct arrayInt {
  int size; int * data;
};

struct arrayReal {
  int size; double * data;
};

struct arrayProb {
  int size; double * data;
};
</code></pre>

<h2 id="measures">Measures</h2>
<p>Measures compile to C functions that take a location for a sample, return the
weight of the measure and store a sample in the location is was given. A simple
example is <code>uniform(0,1)</code> a measure over type <code>real</code>.</p>
<pre><code>#include &lt;time.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

double measure(double * s_a)
 {
    *s_a = ((double)0) + ((double)rand()) / ((double)RAND_MAX) * ((double)1) - ((double)0);
    return 0;
 }

int main()
 {
    double sample;
    while (1)
    {
        measure(&amp;sample);
        printf(&quot;%.17f\n&quot;,sample);
    }
    return 0;
 }
</code></pre>

<p>Recall that weights have type <code>prob</code> and are stored in the log-domain. This
example has a weight of 1.</p>
<p>Calling <code>hkc</code> on a measure will create a function like the one above and also a
main function that infinitely takes samples. Using <code>hkc -F ARG</code> will produce
just the function with the name of its argument.</p>
<h2 id="lambdas">Lambdas</h2>
<p>Lambdas compile to functions in C:</p>
<pre><code>fn x array(real):
  (summate i from 0 to size(x): x[i])
   *
  prob2real(recip(nat2prob((size(x) + 1))))

</code></pre>

<p>Becomes:</p>
<pre><code>#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

struct arrayReal {
   int size; double * data;
 };

double fn_a(struct arrayReal x_b)
 {
   unsigned int i_c;
   double acc_d;
   double p_e;
   double _f;
   double r_g;
   acc_d = 0;
   for (i_c = 0; i_c &lt; x_b.size; i_c++)
   {
     acc_d += *(x_b.data + i_c);
   }
   p_e = log1p(((1 + x_b.size) - 1));
   _f = -p_e;
   r_g = (expm1(_f) + 1);
   return (r_g * acc_d);
 }
</code></pre>

<p>Using the <code>-F</code> flag will allow the user to add their own name to a function,
otherwise the name is chosen automatically as <code>fn_&lt;unique identifier&gt;</code>.</p>
<h2 id="computations">Computations</h2>
<p>When compiling a computation, HKC just creates a main function to compute the
value and print it. For example:</p>
<pre><code>summate i from 1 to 100000000:
  nat2real(i) / nat2real(i)
</code></pre>

<p>becomes:</p>
<pre><code class="C">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

int main()
 {
    double result;
    int i_a;
    double acc_b;
    double _c;
    acc_b = 0;
    for (i_a = 1; i_a &lt; 100000000; i_a++)
    {
       _c = (1 / ((double)i_a));
       acc_b += (_c * ((double)i_a));
    }
    result = acc_b;
    printf(&quot;%.17f\n&quot;,result);
    return 0;
 }
</code></pre>

<h2 id="parallel-programs">Parallel Programs</h2>
<p>Calling HKC with the <code>-j</code> flag will generate the code with parallel regions to
compute the value. The parallel code uses OpenMP directives. To check if you&rsquo;re
compiler supports OpenMP, check <a href="http://openmp.org/wp/openmp-compilers/">here</a>.</p>
<p>For example, GCC requires the <code>-fopenmp</code> flag for OpenMP support:</p>
<pre><code>hkc -j foo.hk -o foo.c
gcc -lm -fopenmp foo.c -o foo.bin
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../../js/mathjaxhelper.js"></script>
    </body>
</html>