<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Hakaru Team">
        
        <link rel="shortcut icon" href="../../favicon.ico">
        

	<title>Transformaitons - Hakaru</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../logo.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Hakaru</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Introduction <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../intro/probprog/">What is Probabilistic Programming</a>
                        </li>
                    
                        <li >
                            <a href="../../intro/installation/">Installation</a>
                        </li>
                    
                        <li >
                            <a href="../../intro/quickstart/">Quick Example</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Language Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../lang/rand/">Random Primitives</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/letbind/">Let and Bind</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/cond/">Conditionals</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/coercions/">Coercions</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/functions/">Functions and Let</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/datatypes/">Datatypes and match</a>
                        </li>
                    
                        <li >
                            <a href="../../lang/arrays/">Arrays</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Transformations <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../transforms/expect/">Expect</a>
                        </li>
                    
                        <li >
                            <a href="../../transforms/disintegrate/">Disintegrate</a>
                        </li>
                    
                        <li >
                            <a href="../../transforms/simplify/">Simplify</a>
                        </li>
                    
                        <li >
                            <a href="../../transforms/mh/">Metropolis Hastings</a>
                        </li>
                    
                        <li >
                            <a href="../../transforms/compile/">Compiling to Haskell</a>
                        </li>
                    
                        <li >
                            <a href="../../transforms/hkc/">Compiling to C</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Internals <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../ast/">AST and Hakaru Datakind</a>
                        </li>
                    
                        <li >
                            <a href="../abt/">ABT</a>
                        </li>
                    
                        <li >
                            <a href="../datums/">Datums</a>
                        </li>
                    
                        <li >
                            <a href="../coercions/">Coercions</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Transformaitons</a>
                        </li>
                    
                        <li >
                            <a href="../testing/">Testing</a>
                        </li>
                    
                        <li >
                            <a href="../newfeature/">Adding a Language Feautre</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../examples/">Examples</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../coercions/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../testing/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/hakaru-dev/hakaru">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#program-transformations-in-hakaru">Program transformations in Hakaru</a></li>
        
            <li><a href="#coalesce">Coalesce</a></li>
        
            <li><a href="#optimizations">Optimizations</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="program-transformations-in-hakaru">Program transformations in Hakaru</h1>
<h2 id="coalesce">Coalesce</h2>
<p>Coalesce is an internal transformation that works on the untyped Hakaru AST. It
takes recursive <code>NAryOp</code> terms that have the same type and combines them into
a single term. For instance:</p>
<pre><code>3.0 + 1.5 + 0.3
</code></pre>

<p>is parser as:</p>
<pre><code>NaryOp Sum [3.0, NaryOp Sum [1.5, NaryOp Sum [0.3]]]
</code></pre>

<p>which when coalesced becomes:</p>
<pre><code>NaryOp Sum [3.0,1.5,0.3]
</code></pre>

<h2 id="optimizations">Optimizations</h2>
<p>The Hakaru AST has a suite of standard compiler optimizations which have
a substantial effect on the runtime of the resulting program.
The current pipeline is described by the <code>optimizations</code> variable in
<code>Language.Hakaru.Syntax.Transforms</code>.
In order, the optimizations performed are:</p>
<ol>
<li>A-normalization</li>
<li>Uniquification of variables (needed for let-floating)</li>
<li>Let-floating</li>
<li>Common subexpression elimination</li>
<li>Pruning of dead binders</li>
<li>Uniquification of variables (for the C backend)</li>
</ol>
<p>Each pass is described in more detail below.</p>
<h3 id="a-normalization">A-normalization</h3>
<p>Found in <code>Language.Hakaru.Syntax.ANF</code></p>
<p>A-normalization converts expressions into <em>administrative normal form</em> (ANF).
This ensures that all intermediate values are named and all arguments to
functions or primitive operations are either literals or variables.
ANF is a common program representation for functional language compilers which
can simplify some compiler passes and make others more effective.
As an example, consider</p>
<pre><code>(add1 (let ([x (f y)]) 5))
</code></pre>

<p>This expression in ANF looks like the following</p>
<pre><code>(let ([x (f y)]) (add1 5))
</code></pre>

<p>which opens up the opportunity for constant folding to eliminate the <code>(add1 5)</code>
expression.
This pass exists mostly to simplify the implementation of CSE, but is useful for
other passes as well.</p>
<h3 id="uniquification">Uniquification</h3>
<p>Found in <code>Language.Hakaru.Syntax.Uniquify</code></p>
<p>Ensures all variables in the program have unique variable identifiers.
This is not strictly necessary, but simplifies the implementation of other
passes, and several of the following passes rely on this property.</p>
<h3 id="let-floating">Let-floating</h3>
<p>Found in <code>Language.Hakaru.Syntax.Hoist</code></p>
<p>See <strong>Let-Floating: Moving Bindings to Give Faster Programs (1996)
by Simon Peyton Jones , Will Partain , Andr√© Santos</strong></p>
<p>Let-floating alters the bindings structure of the program in order to improve
performance.
Typically, this entails moving definitions into or out of lambda expressions.
When a lambda expression encodes a loop, this effectively accomplishes
loop invariant code motion.
This pass only moves definitions upward in the AST.
For the most part, we are only interested in looping constructs like <code>summate</code> and
<code>product</code>, and moving <code>summate</code> expressions out of other <code>summate</code> or <code>product</code>
expressions when they do not depend on the index.
This can radically alter the asymptotics of the resulting program, as nested
loops are converted into sequentially executed loops.</p>
<p>The only assumption this pass makes about the input AST is that all variable
identifiers are unique.
This is to handle the case where two branches of a match statement introduce the
same variable.
If both binders are hoisted out of the match statement, they one binding will
shadow the other.</p>
<p>This pass, as implemented, unconditionally floats expression to where their data
dependencies are fulfilled.
This is not safe in a general purpose language, and we may need to layer some
heuristics on top of this pass to make it less aggressive if we end up
introducing performance regressions.</p>
<h3 id="common-subexpression-elimination">Common Subexpression Elimination</h3>
<p>Found in <code>Language.Hakaru.Syntax.CSE</code></p>
<p>Common subexpression elimination eliminates redundant computation by reusing
results for equivalent expressions.
The current implementation of this pass relies on the program being in ANF.</p>
<p>ANF simplifies the implementation of CSE greatly by ensuring all expressions are
named and that if two expressions may be shared, one of them is let-bound so
that it dominates the other.
In short, ANF simplifies the program to a simple top-down traversal of the AST.
Consider the example</p>
<pre><code>(+ (add1 z) (add1 z))
</code></pre>

<p>Eliminating the common expression <code>(add1 z)</code> requires us to know the evaluation
order of arguments, recognize when an expression is duplicated, and introduce it
with a new name that dominates all use sites of that expression.
However, an expression in ANF allows us to perform CSE simply by keeping track
of let-bound expressions and propagating those expressions downward into the
AST.
Consider the example in ANF</p>
<pre><code>(let ([t1 (add1 z)])
  (let ([t2 (add1 z)])
    (+ t1 t2)))
</code></pre>

<p>To remove the common subexpression, we simply have to note that the <code>(add1 z)</code>
bound to <code>t2</code> is equivalent to the expression bound to <code>t1</code> and replace it with
the variable <code>t1</code>.</p>
<pre><code>(let ([t1 (add1 z)])
  (let ([t2 t1])
    (+ t1 t2)))
</code></pre>

<p>Trivial bindings can then be eliminated, if desired, giving</p>
<pre><code>(let ([t1 (add1 z)])
  (+ t1 t1)))
</code></pre>

<p>A major goal of CSE is to cleanup any work which is duplicated by the
let-floating pass.</p>
<h3 id="pruning">Pruning</h3>
<p>This is essentially a limited form of dead code elimination.
If an expression is bound to a variable which is never referenced, then that
expression need never be executed, as the code language has no side effects.
This pass serves to clean up some of the junk introduced by other passes.</p>
<p>Cases which are handled</p>
<ol>
<li><code>(let ([x e1]) e2) =&gt; e2 if x not in fv(e2)</code></li>
<li><code>(let ([x e1]) x)  =&gt; e1</code></li>
</ol></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../../js/mathjaxhelper.js"></script>
    </body>
</html>